#Â© Mikey - All rights reserved.
#Telegram: @SSUU_R

import os
import asyncio
from pyrogram import Client, filters
import pyromod.listen   # âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªÙØ¹ÙŠÙ„ .listen
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from pyrogram.errors import (
    PhoneCodeInvalid,
    PhoneNumberInvalid,
    PhoneCodeExpired,
    SessionPasswordNeeded,
    PasswordHashInvalid,
    UsernameInvalid
)

# Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§
apid = 123456            # api_id Ù…Ù† my.telegram.org
hash = "your_api_hash"   # api_hash Ù…Ù† my.telegram.org
bot_token = "your_bot_token"   # ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù…Ù† BotFather

bot = Client("bots", api_id=apid, api_hash=hash, bot_token=bot_token)

accounts_folder = "accounts"
if not os.path.exists(accounts_folder):
    os.makedirs(accounts_folder)

# Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
@bot.on_message(filters.command(["start"]))
async def start(bot, msg):
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨", callback_data="add"),
         InlineKeyboardButton("Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", callback_data="show")],
        [InlineKeyboardButton("Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨", callback_data="delet"),
         InlineKeyboardButton("Ø¬Ù„Ø¨ ÙƒÙˆØ¯", callback_data="LastCode")],
        [InlineKeyboardButton("Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", callback_data="Control")]
    ])
    await msg.reply_text(
        "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ®Ø²ÙŠÙ† Ø­Ø³Ø§Ø¨Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡Ø§!\n\n"
        "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡:", 
        reply_markup=keyboard
    )

# Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
async def show_accounts(call):
    try:
        account_files = os.listdir(accounts_folder)
        if account_files:
            account_list = [file.replace(".txt", "") for file in account_files]
            account_count = len(account_list)
            accounts_text = "\n".join(account_list)
            response_text = f"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: {account_count}\n\nØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:\n{accounts_text}"
        else:
            response_text = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø®Ø²Ù†Ø©."
        
        await bot.edit_message_text(
            chat_id=call.message.chat.id, 
            message_id=call.message.id, 
            text=response_text
        )
    except FileNotFoundError:
        await bot.edit_message_text(
            chat_id=call.message.chat.id, 
            message_id=call.message.id, 
            text="Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯."
        )

# Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
@bot.on_callback_query()
async def handle_callback_query(bot, call):
    if call.data == "add":
        await bot.edit_message_text(
            chat_id=call.message.chat.id, 
            message_id=call.message.id, 
            text="ğŸ“± Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† ÙØ¶Ù„Ùƒ:"
        )

        # âœ… Ø¨ÙØ¶Ù„ pyromod.listen Ø§Ù„Ø¢Ù† Ø§Ù„Ø¨ÙˆØª ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        data = await bot.listen(chat_id=call.from_user.id, filters=filters.text & filters.private)
        phone_number = data.text.strip()

        await bot.send_message(chat_id=call.message.chat.id, text=f"ğŸ“ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø±Ù‚Ù… {phone_number}...")

        # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©
        session_connect = Client(phone_number, api_id=apid, api_hash=hash)

        try:
            await session_connect.connect()
            code_data = await session_connect.send_code(phone_number=phone_number)
        except PhoneNumberInvalid:
            await bot.send_message(chat_id=call.message.chat.id, text="âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­")
            await session_connect.disconnect()
            return

        # Ø·Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await bot.send_message(chat_id=call.message.chat.id, text="ğŸ“© Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Ùƒ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:")

        data = await bot.listen(chat_id=call.from_user.id, filters=filters.text & filters.private)
        try:
            VerCode = int(data.text.strip())
        except ValueError:
            await bot.send_message(chat_id=call.message.chat.id, text="âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­")
            await session_connect.disconnect()
            return

        try:
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            await session_connect.sign_in(
                phone_code=str(VerCode), 
                phone_code_hash=code_data.phone_code_hash, 
                phone_number=phone_number
            )

            # Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
            user = await session_connect.get_me()
            username = user.username if user.username else "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙŠÙˆØ²Ø±"
            full_name = user.first_name + " " + (user.last_name if user.last_name else "")
            session_string = await session_connect.export_session_string()

            # Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©
            session_file_path = os.path.join(accounts_folder, f"{phone_number}.txt")
            with open(session_file_path, "w") as f:
                f.write(f"{phone_number}\n{session_string}\n")
                f.write(f"User - {username}\n")
                f.write(f"Name - {full_name}\n")

            await bot.send_message(chat_id=call.message.chat.id, text="âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨")
        except (PhoneCodeExpired, PhoneCodeInvalid):
            await bot.send_message(chat_id=call.message.chat.id, text="âŒ Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡.")
            await session_connect.disconnect()
            return
        except SessionPasswordNeeded:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†
            await bot.send_message(chat_id=call.message.chat.id, text="ğŸ” Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ù…ÙŠ Ø¨Ø±Ù…Ø² ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†.\nØ£Ø±Ø³Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:")
            data = await bot.listen(chat_id=call.from_user.id, filters=filters.text & filters.private)
            password = data.text.strip()

            try:
                await session_connect.check_password(password)

                user = await session_connect.get_me()
                username = user.username if user.username else "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙŠÙˆØ²Ø±"
                full_name = user.first_name + " " + (user.last_name if user.last_name else "")
                session_string = await session_connect.export_session_string()

                session_file_path = os.path.join(accounts_folder, f"{phone_number}.txt")
                with open(session_file_path, "w") as f:
                    f.write(f"{phone_number}\n{session_string}\n")
                    f.write(f"User - {username}\n")
                    f.write(f"Name - {full_name}\n")

                await bot.send_message(chat_id=call.message.chat.id, text="âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨")
            except PasswordHashInvalid:
                await bot.send_message(chat_id=call.message.chat.id, text="âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£")
                await session_connect.disconnect()
                return

    elif call.data == "show":
        await show_accounts(call)

    elif call.data == "delet":
        await bot.send_message(chat_id=call.message.chat.id, text="ğŸ—‘ï¸ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡:")
        data = await bot.listen(chat_id=call.from_user.id, filters=filters.text & filters.private)
        phone_number = data.text.strip()

        session_path = os.path.join(accounts_folder, f"{phone_number}.txt")
        if os.path.exists(session_path):
            os.remove(session_path)
            await bot.send_message(chat_id=call.message.chat.id, text="âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨")
        else:
            await bot.send_message(chat_id=call.message.chat.id, text="âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.run()
